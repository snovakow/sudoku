<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title></title>
	<meta name="viewport" content="width=device-width,initial-scale=1">

	<script type="module">
		const fromFile = true;

		const body = document.createElement('div');

		body.style.fontFamily = "'Courier New', monospace";

		const generateButton = document.createElement('button');
		generateButton.appendChild(document.createTextNode("+"));
		generateButton.style.top = '8px';
		generateButton.style.right = '8px';
		generateButton.style.position = 'absolute';
		generateButton.style.width = '32px';
		generateButton.style.height = '32px';

		const dataStore = [];
		const writeData = (count) => {
			const link = document.createElement("a");
			const file = new Blob([dataStore.join('\n')], { type: 'text/plain' });
			link.href = URL.createObjectURL(file);
			link.download = `sudokus${count}.txt`;
			link.click();
			URL.revokeObjectURL(link.href);
			dataStore.length = 0;
		};

		let worker = null;
		generateButton.addEventListener('click', () => {
			if (worker) {
				worker.terminate();
				worker = null;
			} else {
				const setMessage = (message) => {
					while (body.firstChild) body.removeChild(body.lastChild);
					for (const line of message) {
						const stat = document.createElement('div');
						stat.appendChild(document.createTextNode(line));
						body.appendChild(stat);
					}
				};

				if (fromFile) {
					const lists = [];
					const datas = [];
					const dataMax = 10;
					let dataCount = 0;
					const fetchCascade = (list, index) => {
						fetch(list).then(response => response.text()).then((data) => {
							datas[index] = data;
							dataCount++;

							if (dataCount === dataMax) {
								worker = new Worker("worker.js", { type: "module" });
								worker.postMessage({
									search: window.location.search,
									puzzles: datas.join('\n'),
								});
								worker.onmessage = (e) => {
									const data = e.data;
									if (data.message) setMessage(data.message);
								};
							}
						});
					}

					for (let i = 1; i <= dataMax; i++) {
						lists.push(`./puzzles/sudokus${i}00000.txt`);
					}
					for (let i = 0; i < dataMax; i++) {
						fetchCascade(lists[i], i);
					}
				} else {
					worker = new Worker("worker.js", { type: "module" });
					worker.postMessage({ search: window.location.search });
					worker.onmessage = (e) => {
						const data = e.data;
						dataStore.push(data.puzzle);
						if (data.totalPuzzles % 100000 === 0) {
							writeData(data.totalPuzzles);
						}

						if (data.message) setMessage(data.message);
					};
				}
			}
		});

		document.body.appendChild(generateButton);
		document.body.appendChild(body);
	</script>

</head>

<body></body>

</html>